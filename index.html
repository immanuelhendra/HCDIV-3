<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDB Resale Price Line Race</title>
    <script type="module">
        import * as echarts from 'https://cdn.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.esm.min.js';

        // Function to parse CSV data
        async function fetchDataFromCSV(url) {
            const response = await fetch(url);
            const data = await response.text();
            const rows = data.trim().split('\n').map(row => row.split(','));

            // Extract headers for years (from 2017 to 2024)
            const headers = rows[0].slice(1); // Skip first column (empty cell above town names)
            const dataTransformed = [];

            rows.slice(1).forEach((row, rowIndex) => {
                const area = row[0]; // Column A
                if (!area) {
                    console.warn(`Row ${rowIndex + 2} has no area name.`);
                    return;
                }

                // Loop through columns for each year and add data points
                row.slice(1).forEach((value, index) => {
                    const date = headers[index];
                    if (date) {
                        dataTransformed.push({
                            Area: area.trim(),
                            Date: date.trim(),
                            ResalePrice: parseFloat(value) || 0 // Handle empty cells as 0
                        });
                    } else {
                        console.warn(`Date header missing at index ${index + 1} for area ${area}.`);
                    }
                });
            });
            console.log("Transformed Data:", dataTransformed); // Debugging line
            return dataTransformed;
        }

        // Load and visualize data
        fetchDataFromCSV('HDB Resale Price since 2017.csv').then(data => {
            const areas = Array.from(new Set(data.map(item => item.Area)));
            const datasetWithFilters = [];
            const seriesList = [];

            // Set up datasets and series for each area
            areas.forEach(area => {
                let datasetId = 'dataset_' + area;
                datasetWithFilters.push({
                    id: datasetId,
                    fromDatasetId: 'dataset_raw',
                    transform: {
                        type: 'filter',
                        config: { and: [{ dimension: 'Area', '=': area }] }
                    }
                });
                seriesList.push({
                    type: 'line',
                    datasetId: datasetId,
                    showSymbol: false,
                    name: area, // Use area name as the series name
                    endLabel: {
                        show: true,
                        formatter: function (params) {
                            return `${params.seriesName}: ${params.value[0] || 'No Data'}`; // params.value[1] accesses ResalePrice
                        }
                    },
                    labelLayout: { moveOverlap: 'shiftY' },
                    emphasis: { focus: 'series' },
                    encode: { 
                        x: 'Date',       // Maps x-axis to Date column
                        y: 'ResalePrice', // Maps y-axis to ResalePrice column
                        tooltip: ['Date', 'ResalePrice'] 
                    }
                });
            });

            // ECharts option configuration with y-axis scale intervals set to 100
            const option = {
                animationDuration: 10000,
                dataset: [{ id: 'dataset_raw', source: data }, ...datasetWithFilters],
                title: { text: 'HDB Resale Prices by Area (2017-2024)' },
                tooltip: { order: 'valueDesc', trigger: 'axis' },
                xAxis: { type: 'category', nameLocation: 'middle' },
                yAxis: { name: 'Resale Price (SGD)', min: 300000, interval: 100000 }, // Set interval to 100 for y-axis
                grid: { right: 140 },
                series: seriesList
            };

            // Initialize the chart
            const chartDom = document.getElementById('main');
            const myChart = echarts.init(chartDom);
            myChart.setOption(option);
        })
        .catch(error => console.error('Error loading CSV data:', error));
    </script>
</head>
<body>
    <h1>HDB Resale Prices Line Race</h1>
    <p>This chart visualizes the trends in HDB resale prices across different areas in Singapore from January 2017 to November 2024.</p>
    <div id="main" style="width: 100%; height: 600px;"></div>
</body>
</html>
